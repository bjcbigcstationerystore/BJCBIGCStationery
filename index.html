<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BJC Big C Stationery Store</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --emerald-900:#064e3b;
      --emerald-700:#047857;
      --emerald-600:#059669;
      --emerald-500:#10b981;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:'Prompt',sans-serif;
      background-color:#064e3b;
      overflow:auto;
      scrollbar-gutter: stable both-edges;
    }

    /* ซ่อนแค่รูปร่าง scrollbar (ยังเลื่อนได้) เมื่ออยู่หน้า verify */
    html.no-scrollbar, body.no-scrollbar{
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    html.no-scrollbar::-webkit-scrollbar,
    body.no-scrollbar::-webkit-scrollbar{ width:0; height:0; background:transparent; }

    /* โครงหน้า */
    .page-container{
      display:flex;
      justify-content:center;
      width:100%;
      min-height:100vh;
      padding:2rem 1rem;
    }
    .page-container.centered{ align-items:center; }     /* กลางจอ */
    .page-container.top{ align-items:flex-start; }      /* ชิดบน */

    .content-card{
      background:rgba(255,255,255,0.96);
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.15);
      width:100%;
      max-width:850px;
      backdrop-filter:blur(10px);
      padding:2.5rem;
      color:#111827;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));
      transition:all .25s ease;
    }
    .btn-primary:hover{
      background:linear-gradient(135deg,var(--emerald-600),var(--emerald-700));
      transform:translateY(-2px);
      box-shadow:0 10px 25px rgba(16,185,129,.3);
    }

    .alert-success{
      background:#ecfdf5;
      border:1px solid #bbf7d0;
      color:#065f46;
      border-radius:12px;
    }

    .emp-frame{
      border:2px solid #059669;
      border-radius:16px;
      background:#fff;
      box-shadow:0 0 15px rgba(5,150,105,0.08);
    }
    .dot{ width:.7rem;height:.7rem;border-radius:9999px;background:#059669;display:inline-block;margin-right:.6rem; }
    .field-row{ display:flex;justify-content:space-between;padding:.35rem 0;border-bottom:1px dashed #e5e7eb; }
    .field-row:last-child{ border-bottom:0 }
    .field-label{ color:#4b5563;font-weight:600 }
    .field-value{ color:#111827;font-weight:500 }
    .pill{ display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .75rem;border-radius:9999px;background:#d1fae5;color:#065f46;font-weight:600;font-size:.9rem }
    .pill .dot{ width:.5rem;height:.5rem;margin:0;background:#10b981 }

    /* ✅ เพิ่มส่วนนี้: เมื่อกดโฟกัสที่ช่องรหัสพนักงาน → ขอบเขียวเข้ม + เงาเขียว */
    #employeeId{
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    #employeeId:focus{
      border-width: 2px;  
      border-color: #059669!important;                     /* เขียวเข้ม */
      box-shadow:0 0 0 3px rgba(16,185,129,0.25);          /* วงแหวน/เงาเขียวอ่อน */
      outline:none;
    }
    #message{
      margin-top: 0.8rem !important;  /* 1.5rem ≈ 24px ปรับได้ตามชอบ */
    }
const API_BASE = 'https://script.google.com/macros/s/AKfycbzMk3CWXyFN8VQUpLdNKHG5z5IUoKYTZO7XDCGFTj-oE-EC3m2sb156xlEAmFLEi0swyQ/exec';
async function getEmployeeData(rawId){
    const url = `${API_BASE}?action=getEmployee&employeeId=${encodeURIComponent(rawId)}&debug=0`;
    const res = await fetch(url, { method:'GET', cache:'no-store' });
    if(!res.ok) return null;
    const data = await res.json().catch(()=>null);
    if (data && data.success && data.data) return data.data;
    return null;
  }
    async function getProducts(company='BJC'){
    const url = `${API_BASE}?action=getProducts&company=${encodeURIComponent(company)}`;
    const res = await fetch(url, { method:'GET', cache:'no-store' });
    if(!res.ok) return { products:{} };
    const data = await res.json().catch(()=>({ products:{} }));
    return data.products || {};
  }
    async function submitForm(payload){
    // payload = { employeeId, company, items, remarks, totalPrice }
    const form = new URLSearchParams();
    form.set('action', 'submitform');
    form.set('employeeId', payload.employeeId || '');
    form.set('company', payload.company || '');
    form.set('items', JSON.stringify(payload.items || {}));
    form.set('remarks', payload.remarks || '');
    form.set('totalPrice', String(payload.totalPrice || ''));

    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString()
    });
    if(!res.ok) return { success:false, error:'HTTP error' };
    return await res.json().catch(()=>({ success:false, error:'Invalid JSON' }));
  } 
  </style>
</head>
<body>
  <div class="page-container centered" id="pageContainer">
    <div class="content-card text-center" id="mainCard">
      <!-- หน้า Home -->
      <div id="homeContent">
        <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png" class="mx-auto w-64 mb-8" alt="Logo"/>
        <h1 class="text-3xl font-bold text-gray-800 mb-2">BJC Big C Stationery Store</h1>
        <h2 class="text-xl font-semibold text-emerald-700 mb-8">ฟอร์มการเบิกอุปกรณ์สำนักงาน</h2>

        <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-6 mb-8 text-left">
          <p class="text-gray-700 leading-relaxed mb-4">
            หลังจากที่ท่านกดส่งคำร้องขอเบิกอุปกรณ์สำนักงานแล้ว จะมีอีเมล์แจ้งรายละเอียดการเบิกเป็นแบบฟอร์มขออนุมัติ
          </p>
          <div class="flex justify-center text-emerald-700 border-t border-emerald-200 pt-4">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/></svg>
            <span class="font-medium">สงสัยเพิ่มเติม โทร 02-1465959 #4384</span>
          </div>
        </div>

        <button onclick="startForm()" class="btn-primary text-white font-semibold py-4 px-12 rounded-full text-lg shadow-lg">
          เริ่มต้นการเบิกอุปกรณ์
        </button>
      </div>

      <!-- หน้า Verify -->
      <div id="verifyContent" class="hidden text-left">
        <button onclick="goBack()" class="flex items-center text-emerald-600 hover:text-emerald-700 font-medium mb-6">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/></svg>
          กลับ
        </button>

        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">ยืนยันตัวตน</h1>
        <h2 class="text-xl font-semibold text-emerald-700 text-center mb-8">กรุณากรอกรหัสพนักงาน</h2>

        <div class="max-w-xl mx-auto">
          <label class="block text-gray-700 font-medium mb-2">รหัสพนักงาน</label>
          <input id="employeeId" type="text" placeholder="กรอกรหัสพนักงาน" 
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 text-center text-lg"
                 oninput="autoVerifyEmployee(this.value.trim())"/>

          <div id="message" class="hidden mt-4 p-4 rounded-lg text-center"></div>
          <div id="employeeInfo" class="hidden mt-4"></div>

          <!-- ปุ่มเดียว: เปลี่ยนข้อความเป็น "ดำเนินการต่อ" เมื่อพบข้อมูล -->
          <button id="verifyBtn" onclick="verifyEmployee()" class="btn-primary w-full text-white font-semibold py-3 mt-4 rounded-full text-lg shadow-lg">
            ยืนยันตัวตน
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const container = document.getElementById('pageContainer');

    function startForm(){ togglePage(true); }
    function goBack(){ togglePage(false); }

    function togglePage(isVerify){
      const home = document.getElementById('homeContent');
      const verify = document.getElementById('verifyContent');

      home.classList.toggle('hidden',isVerify);
      verify.classList.toggle('hidden',!isVerify);

      // รีเซ็ตฟอร์ม/ข้อความ
      document.getElementById('employeeId').value="";
      hideEmployeeInfo();
      const msg = document.getElementById('message');
      msg.classList.add('hidden'); msg.textContent = "";

      // ⬇️ เข้าหน้า Verify: เริ่ม "ตรงกลาง" + ซ่อนรูปร่าง scrollbar
      if(isVerify){
        setCentered();
        document.documentElement.classList.add('no-scrollbar');
        document.body.classList.add('no-scrollbar');
      }else{
        container.classList.remove('top'); container.classList.add('centered');
        document.documentElement.classList.remove('no-scrollbar');
        document.body.classList.remove('no-scrollbar');
      }

      window.scrollTo({top:0,behavior:'instant'});
    }

    // helper: จัดตำแหน่ง
    function setCentered(){ container.classList.remove('top'); container.classList.add('centered'); }
    function setTop(){ container.classList.remove('centered'); container.classList.add('top'); }
const toLatinDigits_ = s =>
    String(s == null ? '' : s).replace(/[๐-๙]/g, d => '0123456789'['๐๑๒๓๔๕๖๗๘๙'.indexOf(d)]);

  const normKeepZeros = s => toLatinDigits_(s)
    .normalize('NFKC')
    .replace(/[\s\-–—_/\.]/g, '');      // ตัดช่องว่าง/ขีด/สแลช/จุด/ขีดล่าง

  const normNoZeros = s => normKeepZeros(s).replace(/^0+/, '');  // ตัดศูนย์นำหน้า (ตัวเลือก)

  // debounce กันเรียกถี่เกินไปขณะพิมพ์
  function debounce(fn, wait=250){
    let t; 
    return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  }

  /* =======================================
     REPLACE: autoVerifyEmployee (นับทุกตัว)
     ======================================= */
  const autoVerifyEmployee = (()=>{
    const run = debounce((value)=>{
      // โหมด auto: ระหว่างพิมพ์ หากยังไม่เจอ ให้ขึ้น "กำลังตรวจสอบ..." (ไม่โชว์ error)
      verifyEmployee(value, /*isAuto*/ true);
    }, 220);
    return (value)=> run(value);
  })();

  /* ============================================================
     REPLACE: verifyEmployee (รองรับ auto และศูนย์/ตัวคั่น/เลขไทย)
     ============================================================ */
  function verifyEmployee(idValue, isAuto=false){
    const raw = idValue || document.getElementById('employeeId').value;
    const msgBox=document.getElementById('message');
    const verifyBtn=document.getElementById('verifyBtn');

    const showMsg=(txt,type)=>{
      msgBox.className='mt-4 p-4 rounded-lg text-center '+
        (type==='error'  ? 'bg-red-100 text-red-700 border border-red-200' :
         type==='success'? 'alert-success' :
         /*loading*/       'bg-blue-100 text-blue-700 border border-blue-200');
      msgBox.textContent=txt; 
      msgBox.classList.remove('hidden');
    };

    const keep = normKeepZeros(raw);
    const no0  = normNoZeros(raw);

    // ถ้าช่องว่างจริง ๆ
    if(!keep){
      verifyBtn.textContent='ยืนยันตัวตน';
      verifyBtn.onclick=()=>verifyEmployee();  // manual
      setCentered();
      msgBox.classList.add('hidden'); msgBox.textContent='';
      hideEmployeeInfo(false);
      return;
    }

    // ระหว่างพิมพ์แสดง loading
    showMsg('กำลังตรวจสอบรหัสพนักงาน...','loading');
    hideEmployeeInfo(false); // ซ่อนผลเดิม

    // ค้นหาแบบยืดหยุ่น
    const emp = getEmployeeData(keep, no0);
    if(emp){
      showEmployeeInfo(emp);      // จะ setTop() + scrollTo ด้านใน
      verifyBtn.textContent='ดำเนินการต่อ';
      verifyBtn.onclick=proceedToForm;
    }else{
      // โหมด auto (ขณะพิมพ์): ยังไม่เจอ → คงสถานะ loading ไว้
      if(!isAuto){
        // โหมดกดปุ่ม: แจ้งไม่พบ
        showMsg('ไม่พบรหัสพนักงานในระบบ กรุณาตรวจสอบอีกครั้ง','error');
        setCentered();
      }
      verifyBtn.textContent='ยืนยันตัวตน';
      verifyBtn.onclick=()=>verifyEmployee(); // manual
    }
  }

  /* =====================================================
     REPLACE: getEmployeeData (ค้นหาแบบยืดหยุ่น/ศูนย์นำหน้า)
     ===================================================== */
  function getEmployeeData(keepInput, no0Input){
    // demo dataset (ฝั่งจริงให้เรียก API แทน)
    const data={
      '1001':{id:'1001',name:'สมชาย ใจดี',company:'BJC Big C Supercenter',status:'Active',formatName:'Mr. Somchai Jaidee',divisionName:'IT Department',costCenter:'CC-1010 - Information Technology'},
      '2002':{id:'2002',name:'ประยุทธ มั่นใจ',company:'BJC Big C Supercenter',status:'Active',formatName:'Mr. Prayuth Manjai',divisionName:'Operations Department',costCenter:'CC-2022 - Operations'},
      '0025':{id:'0025',name:'ตัวอย่าง ศูนย์นำหน้า',company:'BJC Big C Supercenter',status:'Active',formatName:'Mr. Leading Zero',divisionName:'Finance',costCenter:'CC-0025 - Finance'} // ตัวอย่างรหัสมี 0 นำหน้า
    };

    // 1) ตรง key ก่อน (กรณีผู้ใช้กรอกครบและตรง)
    if(data[keepInput]) return data[keepInput];

    // 2) ไล่หาโดยเปรียบเทียบแบบ keep/no-zero ทั้งสองฝั่ง
    const values = Object.values(data);
    for(const emp of values){
      const keepRow = normKeepZeros(emp.id);
      const no0Row  = normNoZeros(emp.id);
      if(keepRow === keepInput || no0Row === no0Input){
        return emp;
      }
    }
    return null;
  }

  /* =======================
     ฟังก์ชันเดิม: ไม่ต้องแก้
     ======================= */
  function showEmployeeInfo(emp){
    setTop();
    window.scrollTo({top:0,behavior:'smooth'});

    const div=document.getElementById('employeeInfo');
    const msgBox=document.getElementById('message');
    msgBox.className='mt-4 alert-success p-4 mb-4 text-center text-base';
    msgBox.textContent='พบข้อมูลพนักงาน กรุณาตรวจสอบความถูกต้อง';
    msgBox.classList.remove('hidden');

    div.innerHTML=`
    <div class="emp-frame p-6">
      <div class="flex items-center mb-4"><span class="dot"></span><h3 class="text-2xl font-bold text-emerald-900">ข้อมูลพนักงาน</h3></div>
      <div class="field-row"><span class="field-label">Employee ID:</span><span class="field-value">${emp.id}</span></div>
      <div class="field-row"><span class="field-label">Full Name:</span><span class="field-value">${emp.name}</span></div>
      <div class="field-row"><span class="field-label">Company:</span><span class="field-value">${emp.company}</span></div>
      <div class="field-row"><span class="field-label">Status:</span><span class="field-value"><span class="pill"><span class="dot"></span>${emp.status}</span></span></div>
      <div class="field-row"><span class="field-label">FORMAT_NAME:</span><span class="field-value">${emp.formatName}</span></div>
      <div class="field-row"><span class="field-label">DIVISION_NAME:</span><span class="field-value">${emp.divisionName}</span></div>
      <div class="field-row"><span class="field-label">COST_CENTER:</span><span class="field-value">${emp.costCenter}</span></div>
    </div>`;
    div.classList.remove('hidden');
  }

  function hideEmployeeInfo(resetToCenter = true){
    const div=document.getElementById('employeeInfo');
    div.classList.add('hidden'); div.innerHTML='';
    const btn=document.getElementById('verifyBtn');
    btn.textContent='ยืนยันตัวตน'; btn.onclick=()=>verifyEmployee();
    if(resetToCenter) setCentered();
  }

  function proceedToForm(){
    document.documentElement.classList.remove('no-scrollbar');
    document.body.classList.remove('no-scrollbar');
    alert("กำลังไปยังฟอร์มการเบิกอุปกรณ์...");
  }
  </script>
</body>
</html>
